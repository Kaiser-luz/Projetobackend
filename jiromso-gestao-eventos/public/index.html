<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jiromso Eventos - Sistema Profissional</title>

    <link rel="stylesheet" href="styles.css">

</head>

<body>

    <header>
        <h1>Jiromso Eventos</h1>
    </header>

    <div class="container">

        <div id="auth-screen" class="card">
            <h2 id="auth-title">Acesso ao Sistema</h2>

            <label for="auth-nome" id="lbl-nome" style="display: none;">Nome Completo</label>
            <input type="text" id="auth-nome" placeholder="Ex: Jo√£o Silva" style="display: none;">

            <label for="auth-email">E-mail</label>
            <input type="email" id="auth-email" placeholder="Ex: usuario@email.com">

            <label for="auth-senha">Senha</label>
            <input type="password" id="auth-senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

            <div id="role-select" style="display: none;">
                <label>Perfil de Acesso:</label>
                <select id="auth-role">
                    <option value="user">Usu√°rio Comum</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>

            <div id="auth-msg-box"></div>

            <button class="btn-primary" onclick="login()" id="btn-login">ENTRAR</button>
            <button class="btn-secondary" onclick="cadastro()" id="btn-cadastro"
                style="display: none;">CADASTRAR</button>

            <p class="link-toggle" onclick="toggleAuthMode()">
                <span id="toggle-text">N√£o possui conta? Cadastre-se aqui</span>
            </p>
        </div>

        <div id="app-screen" style="display: none;">

            <div class="card"
                style="display: flex; justify-content: space-between; align-items: center; background-color: #fdfdfd;">
                <div>
                    <small>Bem-vindo(a),</small><br>
                    <strong id="user-display" style="font-size: 1.2rem;"></strong>
                    <span id="role-badge" class="badge"></span>
                </div>
                <button class="btn-outline" onclick="logout()" style="width: auto;">SAIR</button>
            </div>

            <div class="card">
                <h2 id="form-title">Novo Evento</h2>
                <input type="hidden" id="ev-id">

                <label>Nome do Evento *</label>
                <input type="text" id="ev-nome" placeholder="Ex: Palestra de Tecnologia">

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <label>Data *</label>
                        <input type="date" id="ev-data">
                    </div>
                    <div style="flex: 1;">
                        <label>Localiza√ß√£o *</label>
                        <input type="text" id="ev-local" placeholder="Ex: Audit√≥rio Principal">
                    </div>
                </div>

                <label>Participantes</label>
                <input type="text" id="ev-parts" placeholder="Ex: Jo√£o, Maria, Pedro...">

                <label>Descri√ß√£o Detalhada</label>
                <textarea id="ev-desc" rows="3" placeholder="Detalhes sobre o evento..."></textarea>

                <div id="ev-msg-box"></div>

                <div class="actions" style="border: none; padding: 0;">
                    <button class="btn-primary" onclick="salvarEvento()" id="btn-salvar">CRIAR EVENTO</button>
                    <button class="btn-outline" onclick="limparForm()" id="btn-cancel"
                        style="display: none;">CANCELAR</button>
                </div>
            </div>

            <h2 style="color: var(--grena); margin-bottom: 20px;">Eventos Agendados</h2>
            <div id="lista-eventos">
                <p style="text-align: center; color: #777;">Carregando eventos...</p>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let isLoginMode = true;

        // --- UTILIT√ÅRIOS ---

        function mostrarMsg(idBox, texto, tipo) {
            const box = document.getElementById(idBox);
            box.innerText = texto;
            box.className = 'msg-box ' + (tipo === 'erro' ? 'msg-erro' : 'msg-sucesso');
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 5000);
        }

        function validarEmail(email) {
            const re = /\S+@\S+\.\S+/;
            return re.test(email);
        }

        function formatarDataBR(dataISO) {
            if (!dataISO) return "Data n√£o definida";
            const partes = dataISO.split('-');
            if (partes.length !== 3) return dataISO;
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        // --- INTERFACE ---

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const elements = {
                nome: document.getElementById('auth-nome'),
                lblNome: document.getElementById('lbl-nome'),
                role: document.getElementById('role-select'),
                btnLogin: document.getElementById('btn-login'),
                btnCadastro: document.getElementById('btn-cadastro'),
                txt: document.getElementById('toggle-text'),
                title: document.getElementById('auth-title')
            };

            if (isLoginMode) {
                elements.nome.style.display = 'none';
                elements.lblNome.style.display = 'none';
                elements.role.style.display = 'none';
                elements.btnLogin.style.display = 'block';
                elements.btnCadastro.style.display = 'none';
                elements.txt.innerText = 'N√£o possui conta? Cadastre-se aqui';
                elements.title.innerText = 'Acesso ao Sistema';
            } else {
                elements.nome.style.display = 'block';
                elements.lblNome.style.display = 'block';
                elements.role.style.display = 'block';
                elements.btnLogin.style.display = 'none';
                elements.btnCadastro.style.display = 'block';
                elements.txt.innerText = 'J√° possui conta? Fa√ßa Login';
                elements.title.innerText = 'Criar Nova Conta';
            }
            document.getElementById('auth-msg-box').style.display = 'none';
        }

        function checkAuth() {
            if (!token || token === "undefined" || token === "null") {
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('app-screen').style.display = 'none';
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;

                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                document.getElementById('user-display').innerText = currentUser.nome;

                const badge = document.getElementById('role-badge');
                const roleText = currentUser.role === 'admin' ? 'ADMINISTRADOR' : 'COLABORADOR';
                badge.innerText = roleText;
                badge.className = `badge badge-${currentUser.role || 'user'}`;

                carregarEventos();
            } catch (e) {
                logout();
            }
        }

        // --- API CALLS ---

        async function login() {
            const email = document.getElementById('auth-email').value.trim();
            const senha = document.getElementById('auth-senha').value;

            if (!email || !senha) return mostrarMsg('auth-msg-box', 'Preencha E-mail e Senha.', 'erro');
            if (!validarEmail(email)) return mostrarMsg('auth-msg-box', 'Insira um e-mail v√°lido (com @).', 'erro');

            try {
                const res = await fetch(API + '/usuarios/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });
                const data = await res.json();

                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    checkAuth();
                } else {
                    mostrarMsg('auth-msg-box', data.message, 'erro');
                }
            } catch (err) {
                mostrarMsg('auth-msg-box', 'Erro de conex√£o com o servidor.', 'erro');
            }
        }

        async function cadastro() {
            const nome = document.getElementById('auth-nome').value.trim();
            const email = document.getElementById('auth-email').value.trim();
            const senha = document.getElementById('auth-senha').value;
            const role = document.getElementById('auth-role').value;

            if (!nome || !email || !senha) return mostrarMsg('auth-msg-box', 'Todos os campos s√£o obrigat√≥rios.', 'erro');
            if (!validarEmail(email)) return mostrarMsg('auth-msg-box', 'E-mail inv√°lido.', 'erro');
            if (senha.length < 4) return mostrarMsg('auth-msg-box', 'A senha deve ter no m√≠nimo 4 caracteres.', 'erro');

            try {
                const res = await fetch(API + '/usuarios', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, senha, role })
                });
                const data = await res.json();

                if (res.ok) {
                    alert('Cadastro realizado com sucesso!');
                    toggleAuthMode();
                } else {
                    mostrarMsg('auth-msg-box', data.message, 'erro');
                }
            } catch (err) {
                mostrarMsg('auth-msg-box', 'Erro de conex√£o.', 'erro');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            token = null;
            location.reload();
        }

        async function carregarEventos() {
            if (!token) return;
            try {
                const res = await fetch(API + '/eventos', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 403 || res.status === 401) { logout(); return; }

                const eventos = await res.json();
                const lista = document.getElementById('lista-eventos');
                lista.innerHTML = '';

                if (eventos.length === 0) lista.innerHTML = '<p style="text-align:center; padding: 20px;">Nenhum evento encontrado.</p>';

                eventos.forEach(ev => {
                    const div = document.createElement('div');
                    div.className = 'evento-item';

                    const isOwner = ev.organizador_id === currentUser.id;
                    const isAdmin = currentUser.role === 'admin';

                    let buttons = '';
                    if (isAdmin || isOwner) {
                        buttons = `
                            <div class="actions">
                                <button class="btn-secondary" onclick='preencherEdit(${JSON.stringify(ev)})'>EDITAR</button>
                                <button class="btn-outline" onclick="deletar(${ev.id})">DELETAR</button>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div class="evento-header">
                            <h3>${ev.nome}</h3>
                            <span class="evento-date">üìÖ ${formatarDataBR(ev.data)}</span>
                        </div>
                        <p><strong>üìç Local:</strong> ${ev.localizacao}</p>
                        <p><strong>üë• Participantes:</strong> ${ev.participantes || 'Nenhum definido'}</p>
                        <p style="margin-top: 10px; font-style: italic;">${ev.descricao || ''}</p>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 10px; border-top: 1px dashed #eee; padding-top:5px;">
                            ID Evento: ${ev.id} | ID Organizador: ${ev.organizador_id}
                        </div>
                        ${buttons}
                    `;
                    lista.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        async function salvarEvento() {
            const id = document.getElementById('ev-id').value;
            const nome = document.getElementById('ev-nome').value.trim();
            const data = document.getElementById('ev-data').value;
            const local = document.getElementById('ev-local').value.trim();
            const parts = document.getElementById('ev-parts').value;
            const desc = document.getElementById('ev-desc').value;

            if (!nome) return mostrarMsg('ev-msg-box', 'O nome do evento √© obrigat√≥rio.', 'erro');
            if (!data) return mostrarMsg('ev-msg-box', 'Selecione uma data no calend√°rio.', 'erro');
            if (!local) return mostrarMsg('ev-msg-box', 'Informe a localiza√ß√£o.', 'erro');

            const body = JSON.stringify({
                nome: nome,
                data: data,
                localizacao: local,
                participantes: parts,
                descricao: desc
            });

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API}/eventos/${id}` : `${API}/eventos`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: body
                });

                if (res.ok) {
                    mostrarMsg('ev-msg-box', `Evento ${id ? 'atualizado' : 'criado'} com sucesso!`, 'sucesso');
                    limparForm();
                    carregarEventos();
                } else {
                    const d = await res.json();
                    mostrarMsg('ev-msg-box', d.message, 'erro');
                }
            } catch (e) { mostrarMsg('ev-msg-box', 'Erro ao salvar.', 'erro'); }
        }

        async function deletar(id) {
            if (!confirm('Tem certeza que deseja remover este evento permanentemente?')) return;
            const res = await fetch(`${API}/eventos/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) carregarEventos();
            else alert('Erro ao deletar. Verifique suas permiss√µes.');
        }

        function preencherEdit(ev) {
            document.getElementById('form-title').innerText = "Editar Evento #" + ev.id;
            document.getElementById('ev-id').value = ev.id;
            document.getElementById('ev-nome').value = ev.nome;
            document.getElementById('ev-data').value = ev.data;
            document.getElementById('ev-local').value = ev.localizacao;
            document.getElementById('ev-parts').value = ev.participantes || '';
            document.getElementById('ev-desc').value = ev.descricao || '';

            document.getElementById('btn-salvar').innerText = "SALVAR ALTERA√á√ïES";
            document.getElementById('btn-cancel').style.display = 'inline-block';
            document.getElementById('app-screen').scrollIntoView({ behavior: 'smooth' });
        }

        function limparForm() {
            document.getElementById('form-title').innerText = "Novo Evento";
            document.getElementById('ev-id').value = '';
            document.getElementById('ev-nome').value = '';
            document.getElementById('ev-data').value = '';
            document.getElementById('ev-local').value = '';
            document.getElementById('ev-parts').value = '';
            document.getElementById('ev-desc').value = '';

            document.getElementById('btn-salvar').innerText = "CRIAR EVENTO";
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('ev-msg-box').style.display = 'none';
        }

        checkAuth();
    </script>
</body>

</html>